いい感じにブレーキをかけたい
============================

「すごい！ブレーキ操作を全くしていないのに停止位置から数十cm以内で止まって2段制動3段緩め成功判定！？」
「いったいどんな魔法を！？」
「何って…止まるまでの距離に応じてATOのAPIでブレーキを調整しただけだが？」

## これは何？

TRAIN CREW 用の運転支援ツールです。

速度の変化から加速度を計算し、
さらに一定の加速度で走行した場合に停車や速度制限充足までに進む距離を計算します。

リアルタイムの加速度で計算を行うだけでなく、それぞれの強さのブレーキを用いた際の加速度も記録し、
これを用いていい感じに停車・速度制限充足ができるように自動でブレーキをかけることもできます。

## 使い方

1. TRAIN CREW および「いい感じにブレーキをかけたい」を起動します。
   起動する順番は、重要ではありません。

2. TRAIN CREW の操作設定で「外部デバイス入出力」を有効にします。

3. 「いい感じにブレーキをかけたい」が表示する各種情報を見ながら運転をしたい場合は、
   見やすいようにウィンドウの配置を調整します。
   環境によっては、TRAIN CREW の解像度を下げることを考えてもいいでしょう。

4. 列車を運転します。
   状況 (車種・天候など) に応じ、「いい感じにブレーキをかけたい」のパラメータを調整してもいいでしょう。
   パラメータは、運転中でも変更できます。

## 各項目の解説

### メニューバー

* 言語 / Language
  UI で表示する言語を設定します。

* 車種
  運転する車種を選択します。
  「自動」にチェックを入れている場合は、車種が変化した際に自動で選択します。
  車種の選択はブレーキの表示に反映されるほか、3000形・3020形では無条件で8段目のブレーキの使用が許可されます。

### ブレーキ情報

ブレーキの各段で記録した加速度と、
その加速度と現在の速度から計算した停車・速度制限充足までの予測走行距離を表示します。
予測走行距離が 10,000 m 以上の場合は、「∞ m」と表示します。

現在かけているブレーキの強さを、ピンクの背景で表示します。
また、これと異なる場合は、現在手動で指定しているブレーキの強さを水色の背景で表示します。

### 列車情報

* 現在の速度
  TRAIN CREW から API で取得した現在の速度を表示します。

* 現在の加速度
  現在の速度の変化量を変化にかかった時間で割った加速度を表示します。

* 停車位置まで
  TRAIN CREW から API で取得した停車位置までの残り距離を表示します。

* 停車まで (予測)
  現在の速度と加速度から、停まるまでに進むと予測した距離を表示します。
  予測した距離が 10,000 m 以上の場合は、「∞ m」と表示します。

* 速度制限位置まで
  「いい感じにブレーキをかけたい」が認識している速度制限のうち、
  制限位置が一番手前にあるものまでの残り距離を表示します。
  これは、「速度制限位置オフセット」を反映した後の距離です。

* 速度制限充足まで (予測)
  現在の速度と加速度から、「速度制限位置まで」に表示している位置に対応する
  速度制限を満たすまでに進むと予測した距離を表示します。
  予測した距離が 10,000 m 以上の場合は、「∞ m」と表示します。

### 設定

* 自動ブレーキを使用
  「いい感じにブレーキをかけたい」が自動でブレーキの操作を行うかを設定します。
  このブレーキ操作はATOのAPIにより行い、TRAIN CREW の運転台やHUDに表示される段数には反映されません。

* 手動ブレーキ時のみ
  チェックを入れると、手動操作によりブレーキ (抑速を含む) がかかっていない場合、
  「いい感じにブレーキをかけたい」が自動でブレーキの操作を行わないようにします。

* EBの使用を許可
  チェックを入れると、3000形・3020形以外の車種において、
  自動でブレーキをかける際の選択肢に非常ブレーキを含めます。
  3000形・3020形の非常ブレーキは、一度入れると解除に長時間かかり、停車位置の調整に適さないため、
  「いい感じにブレーキをかけたい」の自動ブレーキでは用いません。

* 連続操作制限
  前回のマスコンやブレーキの操作 (手動を含む) からこの時間が経過するまでは、
  自動ブレーキ機能によるブレーキ段数の変更を行いません。
  操作直後、操作が加速度に反映されきらないうちに次の操作を行うと加速度の判断に支障が出るため、
  これを防ぐ役割があります。

* 停車制限
  自動ブレーキにおいて、停車位置からここで設定した距離を越えて手前には停まらないことを目標とします。

* 加速度サンプリング間隔
  加速度を計算する際、現在の速度に加え、どのくらい前の速度を用いるかを設定します。

* 加速度記録制限
  前回のマスコンやブレーキの操作 (手動を含む) からこの時間が経過するまでは、
  ブレーキ情報の加速度を更新しません。
  操作直後、操作が加速度に反映されきらないうちに記録を行うと誤った加速度の情報になるため、
  これを防ぐ役割があります。

* 速度制限充足制限
  自動ブレーキにおいて、速度制限が行われる位置からここで設定した距離を越えて
  手前で速度制限を満たさないことを目標とします。
  基準となる「速度制限が行われる位置」は、「速度制限位置オフセット」を反映した後の位置です。

* 速度制限位置オフセット
  速度制限が行われると認識する位置を、実際の位置からこの距離だけ手前にします。
  予測より減速に時間がかかるなどした場合でも、速度制限を超過しにくくする役割があります。

* 速度制限余裕
  満たそうとする制限速度を、実際の制限速度からこの分低くします。
  予測より減速に時間がかかるなどした場合でも、速度制限を超過しにくくする役割があります。

## 使用上の注意点

自動ブレーキ機能を用いると、簡単に停止位置付近に停車できるため、高いスコアが出やすくなります。
そのため、実力によるプレイのハイスコア情報を破壊する可能性があります。

* 最初にわざと遅れて発車することで、定時運転の加点を避け、スコアを下げる
* 最後の駅などに停車したら、すぐにポーズをかけて運転中止し、ハイスコアの記録を避ける

などの対策が考えられますが、
もとのハイスコアが低すぎる場合など、加点を避けてもハイスコアが更新されてしまう可能性もあります。
ハイスコア情報を破壊したくない場合は、十分注意して操作を行ってください。
対策を怠る・操作を誤るなどによりハイスコア情報が破壊されるなどの損害が発生しても、
本ソフトウェアの作者は責任を負いません。

本ソフトウェアの自動ブレーキ機能は実験的な位置付けであり、
状況により遅延が発生する・制限速度を超過してしまうなどの問題が発生する場合があります。
必要に応じ、手動でブレーキをかけるなどの対処を行ってください。

## 関連リンク

* いい感じにブレーキをかけたい
  * https://github.com/mikecat/ii_kanzi_ni_brake_kaketai
* TRAIN CREW
  * https://acty-soft.com/traincrew/
  * https://store.steampowered.com/app/1618290/TRAIN_CREW/

## ライセンス

「いい感じにブレーキをかけたい」は、MITライセンスです。

```
Copyright (c) 2024-2025 みけCAT

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

TrainCrewInput.dll (TRAIN CREW 入出力ライブラリ) は
溝月レイル/Acty様の制作物であり、MITライセンスの対象外です。
TrainCrewInput.dll の解析や改変は禁止されています。
